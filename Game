class Game:
    def __init__(self):
        self.vault = ArtifactVault()
        self.current_player = None
        self.players_file = "players.json"
        self.credentials_file = "users.txt"
        self.adventure_game = None

    def save_credentials(self, username, password):
        with open(self.credentials_file, 'a', encoding='utf-8') as f:
            f.write(f"{username}:{password}\n")

    def check_credentials(self, username, password):
        if not os.path.exists(self.credentials_file):
            return False

        with open(self.credentials_file, 'r', encoding='utf-8') as f:
            for line in f:
                if line.strip():
                    stored_user, stored_pass = line.strip().split(':')
                    if stored_user == username and stored_pass == password:
                        return True
        return False

    def save_game(self, player):
        if os.path.exists(self.players_file):
            with open(self.players_file, 'r', encoding='utf-8') as f:
                players = json.load(f)
        else:
            players = {}

        players[player.username] = player.to_dict()

        with open(self.players_file, 'w', encoding='utf-8') as f:
            json.dump(players, f, ensure_ascii=False, indent=2)
        print("\n –ò–≥—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!")

    def load_game(self, username):
        if not os.path.exists(self.players_file):
            return None

        with open(self.players_file, 'r', encoding='utf-8') as f:
            players = json.load(f)

        if username in players:
            return Player.from_dict(players[username])
        return None

    def register(self):
        print("\n" + "=" * 20)
        print("–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –ù–û–í–û–ì–û –ò–ì–†–û–ö–ê")
        print("=" * 20)

        while True:
            username = input("–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ª–æ–≥–∏–Ω: ").strip()
            if not username:
                print("–õ–æ–≥–∏–Ω –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!")
                continue

            if os.path.exists(self.credentials_file):
                with open(self.credentials_file, 'r', encoding='utf-8') as f:
                    for line in f:
                        if line.strip() and line.split(':')[0] == username:
                            print("–≠—Ç–æ—Ç –ª–æ–≥–∏–Ω —É–∂–µ –∑–∞–Ω—è—Ç!")
                            break
                    else:
                        break
            else:
                break

        password = input("–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å: ").strip()
        self.save_credentials(username, password)

        self.current_player = Player(username)
        print(f"\n –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {username}!")
        return self.current_player

    def login(self):
        print("\n" + "=" * 50)
        print("–í–•–û–î –í –ò–ì–†–£")
        print("=" * 50)

        username = input("–õ–æ–≥–∏–Ω: ").strip()
        password = input("–ü–∞—Ä–æ–ª—å: ").strip()

        if self.check_credentials(username, password):
            player = self.load_game(username)
            if player:
                self.current_player = player
                print(f"\n –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥! –ó–∞–≥—Ä—É–∂–µ–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –∏–≥—Ä–∞.")
                print(f" –†–µ–ø—É—Ç–∞—Ü–∏—è: {player.reputation}")
                print(f" –≠–∫–∑–∞–º–µ–Ω—ã: {player.exams}")
                print(f" –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã: {len(player.artifacts)} —à—Ç.")
            else:
                self.current_player = Player(username)
                print(f"\n –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥! –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂.")
            return self.current_player
        else:
            print("\n –ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å!")
            return None

    def intro(self):
        print("\n" + "=" * 20)
        print("–î–û–ë–†–û –ü–û–ñ–ê–õ–û–í–ê–¢–¨ –í –ò–ì–†–£!")
        print("=" * 20)
        print("\n–í–Ω–∏–º–∞–Ω–∏–µ! –í–∞—à–∞ –≥–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å - —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∏–ø–µ–Ω–¥–∏—é.")
        print("–û—Ç –≤–∞—à–∏—Ö —Ä–µ—à–µ–Ω–∏–π –∑–∞–≤–∏—Å–∏—Ç, –ø–æ–ª—É—á–∏—Ç–µ –ª–∏ –≤—ã –¥–µ–Ω—å–≥–∏ –Ω–∞ –∂–∏–∑–Ω—å!")
        print("\n–£ –≤–∞—Å –µ—Å—Ç—å:", self.current_player.lives, "–ø–æ–ø—ã—Ç–∫–∏ –Ω–∞ –ø–µ—Ä–µ—Å–¥–∞—á—É")
        print("–¢–µ–∫—É—â–∞—è —Ä–µ–ø—É—Ç–∞—Ü–∏—è:", self.current_player.reputation)
        print("-" * 50)

    def retake_exam(self):
        print("\n--- –ü–ï–†–ï–°–î–ê–ß–ê ---")
        print("–£ –≤–∞—Å –æ—Å—Ç–∞–ª–æ—Å—å –ø–æ–ø—ã—Ç–æ–∫:", self.current_player.lives)

        self.current_player.lives -= 1
        success_chance = min(0.3 + (self.current_player.reputation / 100), 0.8)

        if random.random() < success_chance:
            print("üéâ –£—Ä–∞! –í—ã —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ—Å–¥–∞–ª–∏!")
            self.current_player.reputation += 10
            return True
        else:
            print("üíÄ –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –ø–µ—Ä–µ—Å–¥–∞—á–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å.")
            self.current_player.reputation -= 5
            return False

    def game_loop(self):
        self.intro()

        self.adventure_game = AdventureGame()

        if self.current_player.artifacts:
            self.adventure_game.player.artifacts = self.current_player.artifacts.copy()

        print("\n" + "=" * 50)
        print("–ù–ê–ß–ê–õ–û –ü–†–ò–ö–õ–Æ–ß–ï–ù–ò–Ø")
        print("=" * 50)
        self.adventure_game.start()

        self.current_player.artifacts = self.adventure_game.player.artifacts.copy()
        self.current_player.special_artifacts_found = self.adventure_game.player.special_artifacts_found

        print("\n" + "=" * 50)
        print("–¢–ï–ö–£–©–ò–ô –°–¢–ê–¢–£–°")
        print("=" * 50)
        print(f"–†–µ–ø—É—Ç–∞—Ü–∏—è: {self.current_player.reputation}")
        print(f"–°—Ç–∏–ø–µ–Ω–¥–∏—è: {'—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞' if self.current_player.scholarship else '–ø–æ—Ç–µ—Ä—è–Ω–∞'}")
        print(f"–≠–∫–∑–∞–º–µ–Ω—ã: {self.current_player.exams}")
        print(f"–ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã: {len(self.current_player.artifacts)} —à—Ç.")
        print(f"–ü–æ–ø—ã—Ç–æ–∫ –Ω–∞ –ø–µ—Ä–µ—Å–¥–∞—á—É: {self.current_player.lives}")

        save_choice = input("\n –•–æ—Ç–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–≥—Ä—É? (–¥–∞/–Ω–µ—Ç): ").lower()
        if save_choice == "–¥–∞":
            self.save_game(self.current_player)
        else:
            print("\n –ü—Ä–æ–≥—Ä–µ—Å—Å –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω! –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ –∫–æ–ø–∏–ª–∫—É.")
            self.vault.return_artifacts(self.current_player)

        if not self.current_player.scholarship:
            print("\n" + "=" * 20)
            print("–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê")
            print("=" * 20)
            print("\n –í—ã –ø–æ—Ç–µ—Ä—è–ª–∏ —Å—Ç–∏–ø–µ–Ω–¥–∏—é!")
            print("–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑, –≤–æ–∑–º–æ–∂–Ω–æ –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ –ø–æ–≤–µ–∑–µ—Ç –±–æ–ª—å—à–µ.")
            return

        if "–Ω–µ —Å–¥–∞–Ω" in self.current_player.exams.values() and self.current_player.lives > 0:
            retake = input("\n–•–æ—Ç–∏—Ç–µ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–µ—Ä–µ—Å–¥–∞—Ç—å? (–¥–∞/–Ω–µ—Ç): ").lower()
            if retake == "–¥–∞":
                if self.retake_exam():
                    print("\n" + "=" * 20)
                    print("–§–ò–ù–ê–õ–¨–ù–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢")
                    print("=" * 20)
                    print(f"–†–µ–ø—É—Ç–∞—Ü–∏—è: {self.current_player.reputation}")
                    print(f"–°—Ç–∏–ø–µ–Ω–¥–∏—è: {'—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞' if self.current_player.check_scholarship() else '–ø–æ—Ç–µ—Ä—è–Ω–∞'}")
                    print(f"–≠–∫–∑–∞–º–µ–Ω—ã: {self.current_player.exams}")

                    if self.current_player.scholarship:
                        print("\n –ü–û–ó–î–†–ê–í–õ–Ø–ï–ú! –í–´ –°–û–•–†–ê–ù–ò–õ–ò –°–¢–ò–ü–ï–ù–î–ò–Æ! ")
                    else:
                        print("\n –í—ã –Ω–µ —Å–º–æ–≥–ª–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∏–ø–µ–Ω–¥–∏—é. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑!")
            else:
                print("\n–í—ã —Ä–µ—à–∏–ª–∏ –Ω–µ –ø–µ—Ä–µ—Å–¥–∞–≤–∞—Ç—å. –ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")
        else:
            print("\n" + "=" * 50)
            print("–§–ò–ù–ê–õ–¨–ù–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢")
            print("=" * 50)
            if self.current_player.check_scholarship():
                print("\n –ü–û–ó–î–†–ê–í–õ–Ø–ï–ú! –í–´ –°–û–•–†–ê–ù–ò–õ–ò –°–¢–ò–ü–ï–ù–î–ò–Æ! ")
            else:
                print("\n –í—ã –Ω–µ —Å–º–æ–≥–ª–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∏–ø–µ–Ω–¥–∏—é. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑!")

    def main_menu(self):
        while True:
            print("\n" + "=" * 50)
            print("–ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ")
            print("=" * 50)
            print("1. –ù–æ–≤–∞—è –∏–≥—Ä–∞")
            print("2. –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–≥—Ä—É")
            print("3. –í—ã—Ö–æ–¥")

            choice = input("\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ: ")

            if choice == "1":
                player = self.register()
                if player:
                    self.game_loop()

                    # –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å—ã–≥—Ä–∞—Ç—å –µ—â–µ —Ä–∞–∑
                    again = input("\n–•–æ—Ç–∏—Ç–µ —Å—ã–≥—Ä–∞—Ç—å –µ—â–µ —Ä–∞–∑? (–¥–∞/–Ω–µ—Ç): ").lower()
                    if again != "–¥–∞":
                        break

            elif choice == "2":
                player = self.login()
                if player:
                    self.game_loop()

                    # –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å—ã–≥—Ä–∞—Ç—å –µ—â–µ —Ä–∞–∑
                    again = input("\n–•–æ—Ç–∏—Ç–µ —Å—ã–≥—Ä–∞—Ç—å –µ—â–µ —Ä–∞–∑? (–¥–∞/–Ω–µ—Ç): ").lower()
                    if again != "–¥–∞":
                        break

            elif choice == "3":
                print("\n–°–ø–∞—Å–∏–±–æ –∑–∞ –∏–≥—Ä—É! –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!")
                break

            else:
                print("–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")


def main():
    game = Game()
    game.main_menu()


if __name__ == "__main__":
    main()
